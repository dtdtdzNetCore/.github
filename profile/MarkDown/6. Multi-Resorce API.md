#  6. Muti-Resouce API
- 명령어 서비스는 플랫폼 모델과 명령어 모델을 둘 다 처리해야한다.
- 요구사항에 따라 명령어 서비스의 모델을 만든다.

## 데이터 계층-Model
- `Models\Platform.cs`
    ```csharp
    namespace CommandsService.Models
    {
        public class Platform
        {
            [Key]
            public int Id { get; set; }
            [Required]
            public int ExternalId { get; set; }
            [Required]
            public string Name { get; set; }
            
            public ICollection<Command> Commands { get; set; } = new List<Command>();
        
        }
    }
    ```
- `Models\Command.cs`
    ```csharp
    namespace CommandsService.Models
    {
        public class Command
        {
            [Key]
            public int Id { get; set; }
            [Required]
            public string HowTo { get; set; }
            [Required]
            public string CommandLine { get; set; }
            [Required]
            public int PlatformID  { get; set; }
            public Platform Platform { get; set; }       
        }
    }
    ```
## 데이터 계층-DBContext
- `Data\AppDbContext.cs`
    ```csharp
    namespace CommandsService.Data
    {
        public class AppDbContext : DbContext
        {
            public AppDbContext(DbContextOptions<AppDbContext> opt) : base(opt)
            {
                
            }

            public DbSet<Platform> Platforms { get; set; }
            public DbSet<Command> Commands { get; set; }

            protected override void OnModelCreating(ModelBuilder modelBuilder)
            {
                modelBuilder
                    .Entity<Platform>()
                    .HasMany(p => p.Commands)
                    .WithOne(p => p.Platform!)
                    .HasForeignKey(p => p.PlatformID);
                    
                modelBuilder
                    .Entity<Command>()
                    .HasOne(p => p.Platform)
                    .WithMany(p => p.Commands)
                    .HasForeignKey(p => p.PlatformID);
            }
        }
    }    
    ```
- `Data\ICommandRepo.cs`
    ```csharp
    namespace CommandsService.Data
    {
        public interface ICommandRepo
        {
            bool SaveChange();

            IEnumerable<Platform> GetAllPlatforms();
            void CreatePlatform(Platform plat);
            bool PlatformExist(int platformId);
            IEnumerable<Command> GetCommandsForPlatform(int platformId);
            Command GetCommand(int platformId, int commandId);
            void CreateCommand(int platformId, Command command);
            
        }
    }
    ```
- `Data\CommandRepo.cs`
```csharp
namespace CommandsService.Data
{
    public class CommandRepo : ICommandRepo
    {
        private AppDbContext _context;

        public CommandRepo(AppDbContext context)
        {
            _context = context;
        }
        public void CreateCommand(int platformId, Command command)
        {
            if (command == null)
            {
                throw new ArgumentException(nameof(command));
            }
            command.PlatformId = platformId;
            _context.Commands.Add(command);
        }

        public void CreatePlatform(Platform plat)
        {
            if (plat == null)
            {
                throw new ArgumentNullException(nameof(plat));
            }
            _context.Platforms.Add(plat);
        }

        public IEnumerable<Platform> GetAllPlatforms()
        {
            return _context.Platforms.ToList();
        }

        public Command GetCommand(int platformId, int commandId)
        {
            return _context.Commands
                .Where(c => c.PlatformId == platformId && c.Id == commandId).FirstOrDefault();
        }

        public IEnumerable<Command> GetCommandsForPlatform(int platformId)
        {
            return _context.Commands
                .Where(c => c.PlatformId == platformId)
                .OrderBy(c => c.Platform.Name);
        }

        public bool PlatformExist(int platformId)
        {
            return _context.Platforms.Any(p => p.Id == platformId);
        }

        public bool SaveChange()
        {
            return (_context.SaveChanges() >= 0);
        }
    }
}
```
## 데이터 계층-Model
- `Models\Platform.cs`
    ```csharp
    namespace CommandsService.Models
    {
        public class Platform
        {
            [Key]
            public int Id { get; set; }
            [Required]
            public int ExternalId { get; set; }
            [Required]
            public string Name { get; set; }
            
            public ICollection<Command> Commands { get; set; } = new List<Command>();
        
        }
    }
    ```
- `Models\Command.cs`
    ```csharp
    namespace CommandsService.Models
    {
        public class Command
        {
            [Key]
            public int Id { get; set; }
            [Required]
            public string HowTo { get; set; }
            [Required]
            public string CommandLine { get; set; }
            [Required]
            public int PlatformId  { get; set; }
            public Platform Platform { get; set; }       
        }
    }
    ```
## 데이터 계층-DTO
- `Dtos\PlatformReadDto.cs`
    ```csharp
    namespace CommandsService.Dtos
    {
        public class PlatformReadDto
        {
            public int Id { get; set; }
            public string Name { get; set; }
        }
    }
    ```
- `Dtos\CommandReadDto.cs`
    ```csharp
    namespace CommandsService.Dtos
    {
        public class CommandReadDto
        {
            public int Id { get; set; }
            public string HowTo { get; set; }
            public string CommandLine { get; set; }
            public int PlatformId  { get; set; }
        }
    }
    ```
- `Dtos\CommandCreateDto.cs`
    ```csharp
    namespace CommandsService.Dtos
    {
        public class CommandCreateDto
        {
            [Required]
            public string HowTo { get; set; }
            [Required]
            public string CommandLine { get; set; }
        }
    }
    ```
## 데이터 계층-AutoMapper Profiles

- `Profiles\CommandsProfile.cs`
    ```csharp
    namespace CommandsService.Profiles
    {
        public class CommandsProfile : Profile
        {
            public CommandsProfile()
            {
                CreateMap<Platform, PlatformReadDto>();
                CreateMap<CommandCreateDto, Command>();
                CreateMap<Command, CommandReadDto>();
            }
        }
    }
    ```
- `Program.cs`에 추가한다.
```csharp
    builder.Services.AddDbContext<AppDbContext>(opt => opt.UseInMemoryDatabase("InMem"));
    builder.Services.AddScoped<ICommandRepo, CommandRepo>();
    builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());
```
### 제어계층 - 액션 메서드
- `Controllers\PlatformController`에 추가한다.
    ```csharp
    private readonly ICommandRepo _repository;
    private readonly IMapper _mapper;

    public PlatformsController(ICommandRepo repository, IMapper mapper)
    {
        _repository = repository;
        _mapper = mapper;
    }
    [HttpGet]
    public ActionResult<IEnumerable<PlatformReadDto>> GetPlatforms()
    {
        System.Console.WriteLine("--> Getting Platforms from CommandsService");
        var platformItems = _repository.GetAllPlatforms();
        return Ok(_mapper.Map<IEnumerable<PlatformReadDto>>(platformItems));
    }
    ...
    ```
- `Controllers\CommandsController`
    ```csharp
    namespace CommandsService.Controllers
    {
        [Route("api/c/platforms/{platformId}/[controller]")]
        [ApiController]
        public class CommandsController : ControllerBase
        {
            private readonly ICommandRepo _repository;
            private readonly IMapper _mapper;

            public CommandsController(ICommandRepo repository, IMapper mapper)
            {
                _repository = repository;
                _mapper = mapper;
            }

            [HttpGet]
            public ActionResult<IEnumerable<CommandReadDto>> GetCommandsForPlatform(int platformId)
            {
                System.Console.WriteLine($"--> Hit GetCommandsForPlatform: {platformId}");
                if (!_repository.PlatformExist(platformId))
                {
                    return NotFound();
                }
                var command = _repository.GetCommandsForPlatform(platformId);
                return Ok(_mapper.Map<IEnumerable<CommandReadDto>>  (command));
            }

            [HttpGet("{commandId}", Name = "GetCommandForPlatform")]
            public ActionResult<CommandReadDto> GetCommandForPlatform(int platformId, int commandId)
            {
                Console.WriteLine($"--> Hit GetCommandForPlatform: {platformId} / {commandId}");
                if (!_repository.PlatformExist(platformId))
                {
                    return NotFound();
                }
                var command = _repository.GetCommand(platformId, commandId);
                if (command == null)
                {
                    return NotFound();
                }

                return Ok(_mapper.Map<CommandReadDto>(command));
            }

            [HttpPost]
            public ActionResult<CommandReadDto> CreateCommandForPlatform(int platformId, CommandCreateDto commandDto)
            {
                System.Console.WriteLine($"--> Hit CreateCommandForPlatform: {platformId}");
                if (!_repository.PlatformExist(platformId))
                {
                    return NotFound();
                }
                var command = _mapper.Map<Command>(commandDto);
                _repository.CreateCommand(platformId, command);
                _repository.SaveChange();
                var commandReadDto = _mapper.Map<CommandReadDto>(command);
                return CreatedAtRoute(nameof(GetCommandForPlatform),
                    new {platformId = platformId, CommandId = commandReadDto.Id}, commandReadDto);
            }

        }
    
    }
    ```
- `dotnet run`후 요청 테스트한다. 
    - GET`http://localhost:6000/api/c/platforms/1/commands`
    - GET`http://localhost:6000/api/c/platforms/1/commands/3`
    - POST`http://localhost:6000/api/c/platforms/1/commands`
```csharp
```