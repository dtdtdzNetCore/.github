# 2. 첫 번째 서비스 구축
.NET Core를 사용하여 플랫폼 서비스를 구축한다.
## VS Code 설정
### 프로젝트 생성하기
- VS Code의 원하는 작업디렉토리로 이동한 뒤 터미널을 연다(Ctrl + Backtick(`)).
    ```powershell
    dotnet new webapi -n PlatformService
    ```
    를 입력하여 프로젝트 템플릿을 불러온다.
### 프로젝트 열기
    ```powershell
    cd PlatformService
    code .
    ```
    로 해당 프로젝트의 vs code 창을 열 수 있다.
### 불필요한 파일 삭제
- `WeatherForecast.cs`, `WeatherForecastController.cs` 등의 불필요한 파일이 있다면 삭제한다.
- .NET의 버전에 따라 없을 수 있다.

### 의존성 추가
- 필요한 NuGet 패키지를 프로젝트에 추가한다.
    ```powershell
    dotnet add package AutoMapper.Extensions.Microsoft.DependencyInjection
    dotnet add package Microsoft.EntityFrameworkCore
    dotnet add package Microsoft.EntityFrameworkCore.Design
    dotnet add package Microsoft.EntityFrameworkCore.InMemory
    dotnet add package Microsoft.EntityFrameworkCore.SqlServer
    ```
- 추가된 NuGet 패키지는 `PlatformService.csproj` 파일에서 확인할 수 있다.
### 프로젝트 열기
- 생성된 프로젝트를 VS Code에서 열기 위해 입력한다.
  
        code -r PlatformService

## 데이터 계층-Model
- `Models\Platform.cs`
    ```csharp
    using System.ComponentModel.DataAnnotations;

    namespace PlatformService.Models
    {
        public class Platform{
            [Key]
            public int Id { get; set; }
            [Required]
            public string Name { get; set; }
            [Required]
            public string Publisher { get; set; }
            [Required]
            public string Cost { get; set; }
        }
    }
    ```
## 데이터 계층-DBContext
- `Data\AppDbContext.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.EntityFrameworkCore;
    using PlatformService.Models;

    namespace PlatformService.Data
    {
        public class AppDbContext : DbContext
        {
            public AppDbContext(DbContextOptions<AppDbContext> opt) : base(opt)
            {

            }

            public DbSet<Platform> Platforms { get; set; }
        }
    }
    ```
- `StatrUp.cs`의 ConfigureServices에 추가
    ```csharp
    services.AddDbContext<AppDbContext>(options => options.UseInMemoryDatabase("InMemoryDb"));
    ```
## 데이터 계층-Repository
- `Data\IPlatformRepo.cs`
    ```csharp
    using System.Collections.Generic;
    using PlatformService.Models;

    namespace PlatformService.Data
    {
        public interface IPlatformRepo
        {
            bool SaveChanges();

            IEnumerable<Platform> GetAllPlatforms();
            
            Platform GetPlatformById(int id);
            
            void CreatePlatform(Platform plat);
        }
    }
    ```
- `Data\PlatformRepo.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using PlatformService.Models;

    namespace PlatformService.Data
    {
        public class PlatformRepo : IPlatformRepo
        {
            private readonly AppDbContext _context;

            public PlatformRepo(AppDbContext context)
            {
                _context = context;
            }
            public void CreatePlatform(Platform plat)
            {
                if(plat == null)
                {
                    throw new ArgumentNullException(nameof(plat));
                }

                _context.Platforms.Add(plat);
            }

            public IEnumerable<Platform> GetAllPlatforms()
            {
                return _context.Platforms.ToList();
            }

            public Platform GetPlatformById(int id)
            {
                return _context.Platforms.FirstOrDefault(p => p.Id == id);
            }

            public bool SaveChanges()
            {
                return _context.SaveChanges() >= 0;
            }
        }
    }
    ```
- `StatrUp.cs`의 ConfigureServices에 추가
    ```csharp
    // AutoMapper 등록
    services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());

    // 레포지토리 패턴을 위한 서비스 등록
    services.AddScoped<IPlatformRepo, PlatformRepo>();
    ```
### 데이터 계층 - DB 준비
- `Data\PrebDB.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using PlatformService.Models;

    namespace PlatformService.Data
    {
        public static class PrepDb
        {
            public static void PrepPopulation(IApplicationBuilder app)
            {
                    using(var serviceScope = app.ApplicationServices.CreateScope())
                    {
                        SeedData(serviceScope.ServiceProvider.GetService<AppDbContext>());
                    }
            }

            private static void SeedData(AppDbContext context)
            {
                    if(!context.Platforms.Any())
                    {
                        Console.WriteLine("--> Seeding Data...");

                        context.Platforms.AddRange(
                            new Platform() { Name = "DotNet", Publisher = "Microsoft", Cost = "Free" },
                            new Platform() { Name = "SQL Server Express", Publisher = "Microsoft", Cost = "Free" },
                            new Platform() { Name = "Kubernetes", Publisher = "Cloud Native Computing Foundation", Cost = "Free" }                
                        );

                        context.SaveChanges();
                    }
                    else
                    {
                        Console.WriteLine("--> We already have data");
                    }
            }
        }
    }
    ```

- `StatrUp.cs`의 Configure에 추가
    ```csharp
    PrepDb.PrepPopulation(app);
    ```
## 데이터 계층 - DTO(Data Transfer Objects)
- `Dtos\PlatformCreateDto.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using System.Linq;
    using System.Threading.Tasks;

    namespace PlatformService.Dtos
    {
        public class PlatformCreateDto
        {
            [Required]
            public string Name { get; set; }
            [Required]
            public string Publisher { get; set; }
            [Required]
            public string Cost { get; set; }
        }
    }
    ```
- `Dtos\PlatformReadDto.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;

    namespace PlatformService.Dtos
    {
        public class PlatformReadDto
        {
            public int Id { get; set; }
            public string Name { get; set; }
            public string Publisher { get; set; }
            public string Cost { get; set; }
        }
    }
    ```
## 데이터 계층-AutoMapper Profiles
- `Profiles\PlatformProfile.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using AutoMapper;
    using PlatformService.Dtos;
    using PlatformService.Models;

    namespace PlatformService.Profiles
    {
        public class PlatformsProfile : Profile
        {
            public PlatformsProfile()
            {
                //Source -> target
                CreateMap<Platform,PlatformReadDto>();
                CreateMap<PlatformCreateDto,Platform>();
            }
        }
    }
    ```
### 제어계층 - 액션 메서드
- `Controllers\PlatformController.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using AutoMapper;
    using Microsoft.AspNetCore.Http.HttpResults;
    using Microsoft.AspNetCore.Mvc;
    using PlatformService.Data;
    using PlatformService.Dtos;
    using PlatformService.Models;

    namespace PlatformService.Controllers
    {   
        [Route("api/[controller]")]
        [ApiController]
        public class PlatformsController : ControllerBase
        {
            private readonly IPlatformRepo _repository;
            private readonly IMapper _mapper;

            public PlatformsController(IPlatformRepo repository, IMapper mapper)
            {
                _repository = repository;
                _mapper = mapper;
            }

            [HttpGet]
            public ActionResult<IEnumerable<PlatformReadDto>> GetPlatforms()
            {
                Console.WriteLine("--> Getting Platforms....");

                var platformItem = _repository.GetAllPlatforms();

                return Ok(_mapper.Map<IEnumerable<PlatformReadDto>>(platformItem));
            }

            [HttpGet("{id}", Name = "GetPlatformById")]
            public ActionResult<PlatformReadDto> GetPlatformById(int id)
            {
                var platformItem = _repository.GetPlatformById(id);
                if (platformItem != null)
                {
                    return Ok(_mapper.Map<PlatformReadDto>(platformItem));
                }

                return NotFound();
            }

            [HttpPost]
            public ActionResult<PlatformReadDto> CreatePlatform(PlatformCreateDto platformCreateDto)
            {
                var platformModel = _mapper.Map<Platform>(platformCreateDto);
                _repository.CreatePlatform(platformModel);
                _repository.SaveChanges();

                var platformReadDto = _mapper.Map<PlatformReadDto>(platformModel);

                return CreatedAtRoute(nameof(GetPlatformById), new {Id = platformReadDto.Id}, platformReadDto);
            }
        }
    }
    ```
### 최종 StartUp.cs, Program.cs
- `StartUp.cs`
    ```csharp
    using Microsoft.AspNetCore.Builder;
    using Microsoft.AspNetCore.Hosting;
    using Microsoft.Extensions.Configuration;
    using Microsoft.Extensions.DependencyInjection;
    using Microsoft.Extensions.Hosting;
    using Microsoft.OpenApi.Models;
    using Microsoft.EntityFrameworkCore;
    using PlatformService.Data;

    namespace PlatformService
    {
        public class Startup
        {
            public Startup(IConfiguration configuration)
            {
                Configuration = configuration;
            }

            public IConfiguration Configuration { get; }

            public void ConfigureServices(IServiceCollection services)
            {
                // 의존성 주입을 위한 DBContext 등록
                services.AddDbContext<AppDbContext>(options => options.UseInMemoryDatabase("InMem"));
                
                services.AddControllers();
                // AutoMapper 등록
                services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());

                // 레포지토리 패턴을 위한 서비스 등록
                services.AddScoped<IPlatformRepo, PlatformRepo>();

                // Register Swagger
                services.AddSwaggerGen(c =>
                {
                    c.SwaggerDoc("v1", new OpenApiInfo { Title = "PlatformService API", Version = "v1" });
                });
            }

            public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
            {
                if (env.IsDevelopment())
                {
                    app.UseDeveloperExceptionPage();
                }

                // Enable middleware to serve generated Swagger as a JSON endpoint
                app.UseSwagger();

                // Enable middleware to serve Swagger UI
                app.UseSwaggerUI(c =>
                {
                    c.SwaggerEndpoint("/swagger/v1/swagger.json", "PlatformService API V1");
                    c.RoutePrefix = string.Empty;
                });

                app.UseHttpsRedirection();

                app.UseRouting();

                app.UseAuthorization();

                app.UseEndpoints(endpoints =>
                {
                    endpoints.MapControllers();
                });

                PrepDb.PrepPopulation(app);
            }
        }
    }
    ```
- `Program.cs`
    ```csharp
    using PlatformService;

    var builder = WebApplication.CreateBuilder(args);

    // Startup 클래스 인스턴스 생성 및 서비스 등록 메서드 호출
    var startup = new Startup(builder.Configuration);
    startup.ConfigureServices(builder.Services);

    var app = builder.Build();

    // HTTP 요청 파이프라인 구성 메서드 호출
    startup.Configure(app, builder.Environment);

    app.Run();
    ```
### Http 요청하기
Insomnia REST 또는 Postman을 사용해서 Controller의 요청 3개를 테스트 합니다.
- `Property\launchSettings.json` Port설정
    ```json
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:5001;http://localhost:5000",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
    ```

- 모든 Platform 요청

    GET `http://localhost:5000/api/platforms`
- 각각의 Platform 요청 (2번)

    GET `http://localhost:5000/api/platforms/2`
- 새 Platform 생성

    POST `http://localhost:5000/api/platforms`

    ```JSON
    {
        "name": "Docker",
        "publisher": "Docker",
        "cost": "Free"
    }
    ```