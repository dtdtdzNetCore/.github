# 9. gRPC
## gRPC 소개
- gRPC(Google Remote Procedure Call)는 구글에서 만든 원격 프로시저 호출 시스템입니다.
  - gRPC는 HTTP/2를 사용하여 이진 메세지를 전송하며, TLS를 통해 보안을 유지합니다.
  - gRPC는 고성능을 제공하는 데 중점을 두고 설계되었습니다.
  - gRPC는 "프로토콜 버퍼(Protocol Buffers, Protobuf)"라는 직렬화 형식을 사용하여 클라이언트와 서버 간의 계약(스키마)을 정의합니다.
  - gRPC는 여러 언어를 지원하여, 예를 들어 C# 클라이언트가 Ruby 서비스에 접근할 수 있습니다.
  - gRPC는 서비스 간 통신 방법으로 자주 사용됩니다.
## 최종 쿠버네티스 네트워크 구성
- `K8S\platform-depl.yaml`에 platformrpc를 추가한다.
    ```yaml
    apiVersion: v1
    kind: Service
    metadata:
    name: platforms-clusterip-srv
    spec:
    type: ClusterIP
    selector:
        app: platformservice
    ports:
    - name: platformservice
        protocol: TCP
        port: 8080
        targetPort: 8080
    - name: platformrpc
        protocol: TCP
        port: 666
        targetPort: 666
    ```
- 플랫폼 서비스에서 `appsettings.Production.json`에 추가한다.
    ```JSON
    {
        ...
        "Kestrel": 
        {
            "Endpoints": 
            { "Grpc": 
                {
                "Protocols" : "Http2",
                "Url": "http://platforms-clusterip-srv:666"
                },
                "webApi":
                {
                "Protocols": "Http1",
                "Url": "http://platforms-clusterip-srv:8080"
                }
            }
        }
    }
    ```
## gRPC 패키지 추가하기
- 플랫폼 서비스와 명령 서비스에서 grpc 패키지를 추가한다. 
  - 플랫폼 서비스
    ```powershell
    dotnet add package Grpc.AspNetCore
    ```
  - 명령 서비스
    ```powershell
    dotnet add package Grpc.Tools
    dotnet add package Grpc.Net.Client
    dotnet add package Google.Protobuf
    ```
## 프로토 파일 작업
- 플랫폼 서비스에서 proto 파일을 만든다.
- `platforms.proto`
    ```proto
    syntax = "proto3";

    option csharp_namespace = "PlatformService";

    service GrpcPlatform {
        rpc GetAllPlatforms (GetAllRequest) returns (PlatformResponse);
    }

    message GetAllRequest {}

    message GrpcPlatformModel {
        int32 platformId = 1;
        string name = 2;
        string publisher = 3;
    }

    message PlatformResponse {
        repeated GrpcPlatformModel platform = 1;
    }
    ```
- `dotnet build`로 gRPC 파일을 생성한다.
## 플랫폼 서비스에 gRPC 서버 추가하기
- `PlatformService.csproj`에 ItemGroup을 추가한다.
    ```csproj
    ...
    <ItemGroup>
        <Protobuf Include="Protos\platforms.proto" GrpcServices="Server" />
    </ItemGroup>
    ```
- `SyncDataServices\Grpc\GrpcPlatformService.cs`

- `Profiles\PlatformProfile.cs`에 추가한다.
    ```csharp
    public PlatformsProfile()
    {  
        ...
        CreateMap<Platform, GrpcPlatformModel>()
            .ForMember(dest => dest.PlatformId, opt => opt.MapFrom(src => src.Id))
            .ForMember(dest => dest.Name, opt => opt.MapFrom(src => src.Name))
            .ForMember(dest => dest.Publisher, opt => opt.MapFrom(src => src.Publisher));
    }
    ```
- `StartUp.cs`에 추가한다.
    ```csharp
     public void ConfigureServices(IServiceCollection services)
    {
        ...
        services.AddGrpc();
    }
    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        ...
        app.UseEndpoints(endpoints =>
        {
            ...
            endpoints.MapGrpcService<GrpcPlatformService>();
            endpoints.MapGet("/protos/platforms.proto", async context => 
            {
                await context.Response.WriteAsync(File.ReadAllText("Protos/platforms.proto"));
            });
        });
    }
    ```
## 명령 서비스에 gRPC 클라이언트 추가하기
- 명령 서비스에서 appsetting에 gRPC 주소를 추가한다.
  - `appsettings.Development.json`
    ```JSON
    {
    ...
    "GrpcPlatform": "https://localhost:5001"
    }
    ```
  - `appsettings.Production.json`
    ```JSON
    {
    ...
    "GrpcPlatform": "http://platforms-clusterip-srv:666"
    }
    ```
- 플랫폼 서비스의 proto파일을 폴더째로 복사해온다.
- `CommandService.csproj`에 ItemGroup을 추가한다.
    ```csproj
    ...
    <ItemGroup>
        <Protobuf Include="Protos\platforms.proto" GrpcServices="Client" />
    </ItemGroup>
    ```
- `dotnet build`로 gRPC 파일을 생성한다.
- `SyncDataServices\Grpc\IPlatformDataClient.cs`
    ```csharp
    namespace CommandsService.SyncDataServices.Grpc
    {
        public interface IPlatformDataClient
        {
            IEnumerable<Platform> ReturnAllPlatforms();
        }
    }
    ```
- `SyncDataServices\Grpc\PlatformDataClient.cs`
    ```csharp
    namespace CommandsService.SyncDataServices.Grpc
    {
        public class PlatformDataClient : IPlatformDataClient
        {
            private readonly IConfiguration _configuration;
            private readonly IMapper _mapper;

            public PlatformDataClient(IConfiguration configuration, IMapper mapper)
            {
                _configuration = configuration;
                _mapper = mapper;
                
            }
            public IEnumerable<Platform> ReturnAllPlatforms()
            {
                System.Console.WriteLine($"--> Calling GRPC Service {_configuration["GrpcPlatform"]}");
                var channel = GrpcChannel.ForAddress(_configuration["GrpcPlatform"]);
                var Client = new GrpcPlatform.GrpcPlatformClient(channel);
                var request = new GetAllRequest();

                try
                {
                    var reply = Client.GetAllPlatforms(request);
                    return _mapper.Map<IEnumerable<Platform>>(reply.Platform);
                }
                catch (Exception ex)
                {
                    System.Console.WriteLine($"--> Could not call GRPC Serer {ex.Message}");;
                    return null;
                }
            }
        }
    }
    ``` 
- `Profiles\CommandsProfile`
    ```csharp
    public PlatformsProfile()
    {
        ...
        CreateMap<Platform, GrpcPlatformModel>()
            .ForMember(dest => dest.PlatformId, opt => opt.MapFrom(src => src.Id))
            .ForMember(dest => dest.Name, opt => opt.MapFrom(src => src.Name))
            .ForMember(dest => dest.Publisher, opt => opt.MapFrom(src => src.Publisher));
    }
    ```
## 명령 서비스에서 DB 준비
- `Data\PrepDb.cs`
    ```csharp
    namespace CommandsService.Data
    {
        public static class PrepDb
        {
            public static void PrepPopulation(IApplicationBuilder applicationBuilder)
            {
                using (var serviceScope = applicationBuilder.ApplicationServices.CreateScope())
                {
                    var grpcClient = serviceScope.ServiceProvider.GetService<IPlatformDataClient>();

                    var platforms = grpcClient.ReturnAllPlatforms();
                
                    SeedData(serviceScope.ServiceProvider.GetService<ICommandRepo>(), platforms);
                }
            }

            private static void SeedData(ICommandRepo repo, IEnumerable<Platform> platforms)
            {
                System.Console.WriteLine("Seeding new platforms...");
                foreach (var plat in platforms)
                {
                    if (!repo.ExteramlPlatformExist(plat.ExternalId))
                    {
                        repo.CreatePlatform(plat);
                    }
                    repo.SaveChange();
                }
            }
        }
    }
    ```
- `Program.cs`에 추가한다.
    ```csharp
    ...
    builder.Services.AddScoped<IPlatformDataClient, PlatformDataClient>();
    ...
    PrepDb.PrepPopulation(app);
    ...
    ```
- 로컬에서 플랫폼 서비스와 명령 서비스를 `dotnet run` 하고 양쪽 서비스에서 요청 테스트하여 일치하는지 확인한다.
## 쿠버네티스에 배포하기
- 플랫폼 서비스와 명령 서비스에서 docker build, push 하고, kubectl rollout restart depolyment 한다.
- 양쪽 서비스에서 요청을 테스트해 본다.